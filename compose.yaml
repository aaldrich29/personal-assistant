services:
  chainlit:
    image: ghcr.io/aaldrich29/personal-assistant-chainlit:main
    container_name: assistant-chainlit
    restart: unless-stopped
    ports:
      - 8501:8501
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - VAULT_PATH=/vault
      - LLM_MODEL=${LLM_MODEL:-google/gemini-3-flash-preview}
      - SEARCH_MODEL=${SEARCH_MODEL:-google/gemini-3-flash-preview:online}
      - EXTRACTION_MODEL=${EXTRACTION_MODEL:-google/gemini-3-flash-preview}
      - ICAL_URL=${ICAL_URL:-}
      - TZ=${TZ:-}
      - OMP_NUM_THREADS=4
      - ORT_DISABLE_CPU_AFFINITY=1
      - TOKENIZERS_PARALLELISM=false
      - CHAINLIT_AUTH_SECRET=${CHAINLIT_AUTH_SECRET}
      - AUTH_USERNAME=${AUTH_USERNAME}
      - AUTH_PASSWORD=${AUTH_PASSWORD}
    volumes:
      - ./vault:/vault
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    depends_on:
      chromadb:
        condition: service_healthy
    networks:
      - assistant-net

  chromadb:
    image: chromadb/chroma:latest
    container_name: assistant-chromadb
    restart: unless-stopped
    environment:
      - CHROMA_SERVER_AUTHN_PROVIDER=
      - ANONYMIZED_TELEMETRY=FALSE
    volumes:
      - ./chromadb_data:/data
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    # ports:
    #   - 8100:8000
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8000'"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - assistant-net

  scheduler:
    image: ghcr.io/aaldrich29/personal-assistant-scheduler:main
    container_name: assistant-scheduler
    restart: unless-stopped
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - VAULT_PATH=/vault
      - LLM_MODEL=${LLM_MODEL:-google/gemini-3-flash-preview:online}
      - TZ=${TZ:-}
      - OMP_NUM_THREADS=4
      - ORT_DISABLE_CPU_AFFINITY=1
      - TOKENIZERS_PARALLELISM=false
    volumes:
      - ./vault:/vault
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    depends_on:
      chromadb:
        condition: service_healthy
    networks:
      - assistant-net

  webdav:
    image: rclone/rclone:latest
    container_name: assistant-webdav
    restart: unless-stopped
    command: serve webdav /vault --addr 0.0.0.0:8080 --user ${AUTH_USERNAME:-admin} --pass ${AUTH_PASSWORD:-changeme} --dir-cache-time 0
    volumes:
      - ./vault:/vault/Assistant
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports:
      - 8080:8080
    networks:
      - assistant-net

  vault-web:
    image: ghcr.io/aaldrich29/personal-assistant-vault-web:main
    container_name: assistant-vault-web
    restart: unless-stopped
    ports:
      - 8081:8000
    environment:
      - AUTH_USERNAME=${AUTH_USERNAME}
      - AUTH_PASSWORD=${AUTH_PASSWORD}
    volumes:
      - ./vault:/vault
    networks:
      - assistant-net

networks:
  assistant-net:
    driver: bridge