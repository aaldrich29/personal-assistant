<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vault Editor</title>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- EasyMDE -->
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --text-color: #cccccc;
            --accent-color: #007acc;
            --border-color: #3e3e42;
            --hover-bg: #2a2d2e;
            --active-bg: #37373d;
            --editor-bg: #1e1e1e;
        }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; }
        #app { display: flex; height: 100%; }
        
        /* Sidebar */
        .sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; user-select: none; flex-shrink: 0; }
        .sidebar-header { padding: 10px; font-weight: bold; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-actions button { background: none; border: none; color: var(--text-color); cursor: pointer; opacity: 0.7; }
        .sidebar-actions button:hover { opacity: 1; color: white; }
        
        .file-tree { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 5px 0; }
        
        /* Tree Item Component */
        .tree-item { cursor: pointer; font-size: 14px; white-space: nowrap; }
        .item-content { display: flex; align-items: center; padding: 4px 10px; position: relative; }
        .item-content:hover { background: var(--hover-bg); }
        .item-content.active { background: var(--active-bg); color: white; }
        .item-icon { margin-right: 6px; width: 16px; text-align: center; color: #dcb67a; }
        .file-icon { color: #519aba; }
        .arrow { font-size: 10px; margin-right: 5px; width: 10px; display: inline-block; transition: transform 0.1s; color: #999; }
        .arrow.expanded { transform: rotate(90deg); }
        .item-actions { display: none; margin-left: auto; font-size: 12px; }
        .item-content:hover .item-actions { display: flex; gap: 8px; }
        .action-btn { color: #aaa; }
        .action-btn:hover { color: white; }

        /* Main Editor */
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .editor-header { height: 40px; background: var(--bg-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0; }
        .file-path { font-size: 0.9em; color: #888; }
        
        /* EasyMDE Dark Mode Overrides */
        .editor-wrapper { flex: 1; position: relative; overflow: hidden; background: var(--editor-bg); }
        .EasyMDEContainer { height: 100%; display: flex; flex-direction: column; }
        
        /* Toolbar */
        .editor-toolbar { 
            background: #333 !important; 
            border: none !important; 
            border-bottom: 1px solid var(--border-color) !important; 
            opacity: 1 !important;
        }
        .editor-toolbar button { color: #ccc !important; }
        .editor-toolbar button:hover, .editor-toolbar button.active { background: #444 !important; color: white !important; border: none !important; }
        .editor-toolbar i.separator { border-left: 1px solid #444 !important; border-right: none !important; }

        /* CodeMirror (Text Area) */
        .CodeMirror { 
            flex: 1; 
            height: auto !important; 
            background: var(--editor-bg) !important; 
            color: #d4d4d4 !important; 
            border: none !important; 
            border-radius: 0 !important; 
            font-family: 'Consolas', 'Courier New', monospace; 
            font-size: 15px; 
        }
        .CodeMirror-cursor { border-left: 2px solid white !important; }
        .CodeMirror-selected { background: #264f78 !important; }
        .CodeMirror-gutters { background: var(--editor-bg) !important; border-right: 1px solid #333 !important; }
        
        /* Markdown Syntax Colors (Simplified) */
        .cm-header { color: #569cd6 !important; font-weight: bold; }
        .cm-url, .cm-link { color: #9cdcfe !important; }
        .cm-variable-2 { color: #9cdcfe !important; } /* lists etc */
        .cm-string { color: #ce9178 !important; }
        .cm-comment { color: #6a9955 !important; }
        .cm-quote { color: #6a9955 !important; }
        .cm-keyword { color: #c586c0 !important; }

        /* Preview Area */
        .editor-preview { background: var(--bg-color) !important; color: var(--text-color) !important; }

        .editor-statusbar { display: none !important; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #333; padding: 20px; border-radius: 5px; width: 300px; border: 1px solid #555; }
        .modal h3 { margin-top: 0; }
        .modal input { width: 100%; padding: 8px; margin: 10px 0; background: #222; border: 1px solid #555; color: white; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Utility */
        .btn { background: var(--accent-color); color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; }
        .btn:hover { background: #0062a3; }
        .btn-cancel { background: #555; }
        .btn-cancel:hover { background: #666; }
        .dirty-indicator { color: #ffeb3b; margin-right: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span><i class="fas fa-vault"></i> VAULT</span>
                <div class="sidebar-actions">
                    <button @click="openModal('create-folder')" title="New Folder"><i class="fas fa-folder-plus"></i></button>
                    <button @click="openModal('create-file')" title="New File"><i class="fas fa-file-circle-plus"></i></button>
                    <button @click="fetchTree" title="Refresh"><i class="fas fa-sync"></i></button>
                </div>
            </div>
            <div class="file-tree">
                <tree-item 
                    v-for="child in tree.children" 
                    :key="child.path" 
                    :item="child"
                    :selected-path="currentPath"
                    @select="loadFile"
                    @action="handleAction"
                ></tree-item>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="editor-header">
                <div class="file-path">
                    <span v-if="isDirty" class="dirty-indicator">‚óè</span>
                    {{ currentPath || 'No file selected' }}
                </div>
                <div style="display:flex; align-items:center;">
                    <span v-if="statusMessage" style="margin-right:10px; font-size:0.8em; color:#4ec9b0;">{{ statusMessage }}</span>
                    <button class="btn" @click="saveFile" :disabled="!currentPath">Save</button>
                </div>
            </div>
            
            <div class="editor-wrapper">
                <textarea id="mde-editor"></textarea>
            </div>
        </div>

        <!-- Modal -->
        <div v-if="modal.show" class="modal-overlay" @click.self="closeModal">
            <div class="modal">
                <h3>{{ modal.title }}</h3>
                <input ref="modalInput" v-model="modal.inputValue" @keyup.enter="confirmModal" :placeholder="modal.placeholder">
                <div class="modal-buttons">
                    <button class="btn btn-cancel" @click="closeModal">Cancel</button>
                    <button class="btn" @click="confirmModal">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/x-template" id="tree-item-template">
        <div class="tree-item">
            <div class="item-content" :class="{ active: isSelected }" @click="handleClick">
                <span class="arrow" :class="{ expanded: isOpen }" v-if="isFolder">
                    <i class="fas fa-chevron-right"></i>
                </span>
                <span class="arrow" v-else></span>
                <span class="item-icon" :class="{ 'file-icon': !isFolder }">
                    <i :class="iconClass"></i>
                </span>
                <span>{{ item.name }}</span>
                <div class="item-actions">
                    <span class="action-btn" @click.stop="$emit('action', 'rename', item)"><i class="fas fa-pencil-alt"></i></span>
                    <span class="action-btn" @click.stop="$emit('action', 'delete', item)"><i class="fas fa-trash"></i></span>
                </div>
            </div>
            <div v-if="isFolder && isOpen" style="padding-left: 15px;">
                <tree-item 
                    v-for="child in item.children" 
                    :key="child.path" 
                    :item="child"
                    :selected-path="selectedPath"
                    @select="$emit('select', $event)"
                    @action="(a, i) => $emit('action', a, i)"
                ></tree-item>
            </div>
        </div>
    </script>

    <script>
        const { createApp, ref, shallowRef, onMounted, computed, nextTick } = Vue;

        const TreeItem = {
            name: 'tree-item', 
            template: '#tree-item-template',
            props: {
                item: Object,
                selectedPath: String
            },
            emits: ['select', 'action'],
            setup(props, { emit }) {
                const isOpen = ref(false);
                const isFolder = computed(() => props.item.type === 'folder');
                const isSelected = computed(() => props.selectedPath === props.item.path);
                const iconClass = computed(() => {
                    if (isFolder.value) return isOpen.value ? 'fas fa-folder-open' : 'fas fa-folder';
                    if (props.item.name.endsWith('.md')) return 'fab fa-markdown';
                    return 'fas fa-file';
                });
                const handleClick = () => {
                    if (isFolder.value) isOpen.value = !isOpen.value;
                    else emit('select', props.item.path);
                };
                return { isOpen, isFolder, iconClass, handleClick, isSelected };
            }
        };

        const app = createApp({
            setup() {
                const tree = ref({ children: [] });
                const currentPath = ref(null);
                const statusMessage = ref("");
                const easyMDE = shallowRef(null);
                const isDirty = ref(false);
                const modal = ref({ show: false, title: '', inputValue: '', placeholder: '', type: '', targetItem: null });
                const modalInput = ref(null);

                const fetchTree = async () => {
                    try {
                        const res = await fetch('/api/tree');
                        tree.value = await res.json();
                    } catch (e) { console.error(e); }
                };

                const loadFile = async (path) => {
                    if (isDirty.value && !confirm("You have unsaved changes. Discard them?")) return;
                    if (currentPath.value === path) return;
                    currentPath.value = path;
                    if (easyMDE.value) easyMDE.value.value("Loading...");
                    try {
                        const res = await fetch(`/api/file/${path}`);
                        if (!res.ok) throw new Error('Failed to load');
                        const data = await res.json();
                        if (easyMDE.value) {
                            easyMDE.value.value(data.content);
                            setTimeout(() => easyMDE.value.codemirror.refresh(), 100);
                            isDirty.value = false;
                        }
                    } catch (e) {
                        console.error(e);
                        statusMessage.value = "Error loading file";
                    }
                };

                const saveFile = async () => {
                    if (!currentPath.value || !easyMDE.value) return;
                    statusMessage.value = "Saving...";
                    try {
                        const content = easyMDE.value.value();
                        const res = await fetch(`/api/file/${currentPath.value}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content })
                        });
                        if (res.ok) {
                            statusMessage.value = "Saved!";
                            isDirty.value = false;
                        }
                        else statusMessage.value = "Error saving";
                        setTimeout(() => statusMessage.value = "", 2000);
                    } catch (e) { statusMessage.value = "Error saving"; }
                };

                const openModal = (type, item = null) => {
                    modal.value.type = type;
                    modal.value.targetItem = item;
                    modal.value.show = true;
                    modal.value.inputValue = "";
                    if (type === 'create-file') { modal.value.title = 'New File Name'; modal.value.placeholder = 'folder/note.md'; }
                    else if (type === 'create-folder') { modal.value.title = 'New Folder Name'; modal.value.placeholder = 'folder/subfolder'; }
                    else if (type === 'rename') { modal.value.title = 'Rename'; modal.value.inputValue = item.path; modal.value.placeholder = 'New path...'; }
                    else if (type === 'delete') { modal.value.title = `Delete ${item.name}?`; modal.value.inputValue = "Type 'yes' to confirm"; }
                    nextTick(() => modalInput.value && modalInput.value.focus());
                };

                const closeModal = () => modal.value.show = false;

                const confirmModal = async () => {
                    const { type, inputValue, targetItem } = modal.value;
                    if (type === 'delete') {
                        if (inputValue.toLowerCase() !== 'yes') return;
                        await fetch(`/api/delete/${targetItem.path}`, { method: 'DELETE' });
                    } else if (type === 'rename') {
                        await fetch('/api/rename', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ old_path: targetItem.path, new_path: inputValue })
                        });
                    } else if (type.startsWith('create')) {
                        const isFolder = type === 'create-folder';
                        await fetch('/api/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ path: inputValue, type: isFolder ? 'folder' : 'file' })
                        });
                    }
                    closeModal();
                    fetchTree();
                };

                const handleAction = (action, item) => openModal(action, item);

                window.onbeforeunload = (e) => {
                    if (isDirty.value) { e.preventDefault(); e.returnValue = ''; }
                };

                onMounted(() => {
                    fetchTree();
                    setTimeout(() => {
                        const el = document.getElementById('mde-editor');
                        if(el) {
                            const mde = new EasyMDE({
                                element: el,
                                spellChecker: false,
                                status: false,
                                autoDownloadFontAwesome: false,
                                toolbar: ["bold", "italic", "heading", "|", "quote", "code", "unordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen"],
                                minHeight: "100%",
                            });
                            mde.codemirror.on("change", () => {
                                if (currentPath.value) isDirty.value = true;
                            });
                            easyMDE.value = mde;
                            easyMDE.value.codemirror.setSize("100%", "100%");
                        }
                    }, 100);
                });

                return {
                    tree, currentPath, statusMessage, modal, modalInput, isDirty,
                    openModal, closeModal, confirmModal, loadFile, saveFile, handleAction, fetchTree
                };
            }
        });

        app.component('tree-item', TreeItem);
        app.mount('#app');
    </script>
</body>
</html>
